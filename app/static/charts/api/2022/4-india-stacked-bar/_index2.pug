extend /partials/layout

block append config
  - var datapath = "static/charts/api/2022/4-india-stacked-bar/data"
  - var colorpath = "static/charts/templates/colors/data"
  - _.extend(page, data.getOne(datapath))
  - _.extend(page, data.getOne(colorpath))
  - toPercent = (n) => (n * 100).toFixed(2) + "%"
  - chart = page
  
block page
  .wrapper.flex
    .txt-center.flex.flex-grow.flex-col
      .chart-title= chart.title
      .chart-subtitle.txt-muted.p-sm!= chart.subtitle
      .chart.flex-grow: .chart-content
        - ln = chart.series[0].values.length
        - axes = chart.axes
        - minY = axes.minY
        - maxY = axes.maxY
        - range = maxY - minY
        - fx = (i) => (i + 0.4) / (ln + 0.75)
        - fy = (y) => (y - minY) / range

            svg(height="100%" width="100%")
              <!-- Y-Axis labels-->
              svg(height="100%")
                svg(y="100.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 0
                svg(y="90.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 10
                svg(y="80.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 20
                svg(y="70.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 30
                svg(y="60.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 40
                svg(y="50.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 50
                svg(y="40.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 60
                svg(y="30.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 70
                svg(y="20.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 80
                svg(y="10.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 90
                svg(y="0.00%")
                  text(text-anchor="end" transform="translate(-8 4)") 100

              svg(x="70" y="55%")
                text.y-label Measures scores
              
              <!-- Y-Axis minor lines-->
              svg(height="100%")
                svg
                  line(x1="0%" y1="0.00%" x2="100%" y2="0.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="10.00%" x2="100%" y2="10.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="20.00%" x2="100%" y2="20.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="30.00%" x2="100%" y2="30.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="40.00%" x2="100%" y2="40.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="50.00%" x2="100%" y2="50.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="60.00%" x2="100%" y2="60.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="70.00%" x2="100%" y2="70.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="80.00%" x2="100%" y2="80.00%" stroke="#5552" stroke-dasharray="")
                svg
                  line(x1="0%" y1="90.00%" x2="100%" y2="90.00%" stroke="#5552" stroke-dasharray="")
              
              <!-- Chart rects-->
              g.bars
                svg(x="4.57%" width="4.57%" height="100%")  
                  rect(y="78.10%" height="21.90%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="89.05%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 22
                  
                  rect(y="75.90%" height="2.20%" width="100%" fill="#ff948d" fill-opacity="100%")
                  text.chart-value(x="50%" y="73%" text-anchor="middle" transform="translate(0 4.5)" style="color: #f00") ↓  2.2
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    //text(text-anchor="middle" transform="translate(0 20)") Economic Capability
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Economic
                      tspan(x="0" dy="12") Capability
                  
                
                svg(x="16.00%" width="4.57%" height="100%")  
                  rect(y="55.9%" height="44.10%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="77.55%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 44
                  
                  rect(y="55.2%" height="0.70%" width="100%" fill="#ff948d" fill-opacity="100%")
                  text.chart-value(x="50%" y="52%" text-anchor="middle" transform="translate(0 4.5)" style="color: #f00") ↓ 0.7
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Military
                      tspan(x="0" dy="12") Capability
                    
                  
                
                svg(x="27.43%" width="4.57%" height="100%")  
                  rect(y="48.80%" height="51.20%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="74.40%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 51
                  
                  rect(y="43.90%" height="4.90%" width="100%" fill="#ff948d" fill-opacity="100%")
                  text.chart-value(x="50%" y="41%" text-anchor="middle" transform="translate(0 4.5)" style="color: #f00") ↓ 4.9
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Resilience
                  
                svg(x="38.86%" width="4.57%" height="100%")  
                  rect(y="52.30%" height="47.70%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="76.15%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 48
                  
                  rect(y="51.30%" height="1.00%" width="100%" fill="#ff948d" fill-opacity="100%")
                  text.chart-value(x="50%" y="49%" text-anchor="middle" transform="translate(0 4.5)" style="color: #f00") ↓  1.0
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Future
                      tspan(x="0" dy="12") Resources
                    
                svg(x="50.29%" width="4.57%" height="100%")  
                  rect(y="84.60%" height="15.40%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="92.30%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 15
                  
                  rect(y="81.40%" height="3.20%" width="100%" fill="#ff948d" fill-opacity="100%")
                  text.chart-value(x="50%" y="79%" text-anchor="middle" transform="translate(0 4.5)" style="color:  #f00") ↓  3.2
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Economic
                      tspan(x="0" dy="12") Relationships
                    
                svg(x="61.71%" width="4.57%" height="100%")  
                  rect(y="78.50%" height="21.50%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="89.25%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 22
                  
                  rect(y="75.90%" height="2.60%" width="100%" fill="#ff948d" fill-opacity="100%")
                  text.chart-value(x="50%" y="73%" text-anchor="middle" transform="translate(0 4.5)" style="color: #f00") ↓  2.6
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Defence
                      tspan(x="0" dy="12") Networks
                                    
                svg(x="73.14%" width="4.57%" height="100%")  
                  rect(y="34.20%" height="65.80%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="67.10%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 66
                  
                  rect(y="32.00%" height="2.20%" width="100%" fill="#16B56F" fill-opacity="50%")
                  text.chart-value(x="50%" y="29%" text-anchor="middle" transform="translate(0 4.5)" style="color: #16B56F") ↑ 2.2
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Diplomatic
                      tspan(x="0" dy="12") Relationships
                                    
                svg(x="84.57%" width="4.57%" height="100%")  
                  rect(y="61.70%" height="38.30%" width="100%" fill="#002b45")
                  //text.chart-value(x="50%" y="80.85%" text-anchor="middle" transform="translate(0 4.5)" style="color: white") 38
                  
                  rect(y="59.20%" height="2.50%" width="100%" fill="#16B56F" fill-opacity="50%")
                  text.chart-value(x="50%" y="56%" text-anchor="middle" transform="translate(0 4.5)" style="color: #16B56F") ↑ 2.5
                  
                  <!-- X-Axis labels-->
                  svg.x-label.txt-tu.txt-sm(x="50%" y="106%")
                    text(text-anchor="middle") 
                      tspan(x="0" dy="0") Cultural
                      tspan(x="0" dy="12") Influence
                    
              rect(stroke="" x="65%" y="4%" height="17%" width="26%" fill="#e0ddee80") 
              text(y="12%" x="70%" text-anchor="start") 
                tspan(x="68%") ↑ Improvement in 2023
                tspan(x="68%" dy="20") ↓ Decline in 2023

      //.row
        ul.legend.list-bare.txt-left.flex.flex-ch
          for ax, i in new Array(chart.series.length)
            if i
              li.legend-item
                span.legend-item-box(style=`background: ${chart.colors[chart.series[i].color]}`)
                span.legend-item-label= chart.series[i].title

      .chart-source.txt-right.txt-muted.txt-cond!= chart.source
      //.chart-notes.txt-right.txt-muted.txt-cond!= chart.notes
      
      .tooltip

  script.


    /* --- USER TO UPDATE --- */
    const enableTooltips = true;
    const nLegendItems = 4;
    const nSeries = 6;
    /* --------------------- */
    
    const chart = document.querySelectorAll('.chart-content');
    const rects = document.querySelectorAll('rect');
    const vals = document.querySelectorAll('.chart-value');
    const series = document.querySelectorAll('.x-label');
    const tooltip = document.querySelector('.tooltip');
    const legendItems = document.querySelectorAll('.legend-item-label');
    
    if (enableTooltips) {
      window.addEventListener('DOMContentLoaded', () => {
        rects.forEach( (rect, i) => addHoverEventListeners(rect, i) );  
      });
    }
        
    function addHoverEventListeners(el, i) {
      el.addEventListener('mouseover', () => {
        
        let val = vals[i].innerHTML;
        let ser = series[ Math.floor(i/nLegendItems) ].innerHTML;
        let cat = legendItems[i % nLegendItems].innerHTML;
        let box = el.getBoundingClientRect();
        
        tooltip.innerHTML = val + " of " + ser + " countries were " + cat + " performing";
        tooltip.style.left = box.left + box.width/2 - tooltip.offsetWidth/2 + 'px';
        tooltip.style.top = box.top - tooltip.offsetHeight + 'px';
        tooltip.style.opacity = 1;
        
      });
      
      el.addEventListener('mouseleave', () => { 
        tooltip.style.opacity = 0;
      });
      
    }
    
  
block append css
  style
    :sass
  
      .wrapper
        height: 550px

      .chart
        box-sizing: border-box
        position: relative

      .chart-content
        position: absolute
        top: 20px
        left: 60px
        right: 20px
        bottom: 40px

      .chart-content > svg
        border-bottom: 1px solid #bbb

      .chart-title
        margin: auto
        font-size: 20px
        
      .chart-subtitle
        /* font-weight: 700
        height: 10px
        margin-top: -10px
        font-size: 15px
        
      .tooltip
        position: absolute
        left: 0
        background: #fffe
        padding: .75em
        opacity: 0
        border-radius: .2em
        box-shadow: 0 0 5px 0 #0004
        transition-duration: 0.5s
        pointer-events: none
        font-size: 14px
        text-transform: lowercase
        max-width: 180px
        box-sizing: border-box

      li
        list-style: none
        margin: 0
        padding: 4px 16px 4px 24px

      .legend
        font-size: 15px
        margin-bottom: .75em

      .legend-item
        margin: 4px 8px 0
        padding-right: 0
        position: relative
        white-space: nowrap

      .legend-item-box
        position: absolute
        left: 0
        top: .5em
        height: 1em
        width: 1em
        background: black

      text
        font-size: 16px
        fill: currentColor

      svg
        overflow: visible
        
      .chart-notes, .chart-source
        margin-top: 1em
        margin-right: 2em
        font-size: 15px
        
      .chart-value
        opacity: 1
        transition-duration: .4s
        pointer-events: none
      
      .chart-content:hover .chart-value
        opacity: 1

      .x-label text
        font-size: 12px
        /* font-weight: 700
        letter-spacing: 0.03em

      .y-label
        transform: rotate(-90deg) translate(-1.5rem, -7.5rem)

      @media (max-width: 700px)
        
        .x-label text
          text-anchor: end
          transform: rotate(-45deg) translate(-8px, 14px)

        text
          font-size: 13px
          
      @media (max-width: 450px)
        .chart-content
          bottom: 40px
        .legend
          flex-direction: column
        .chart-title
          font-size: 18px
        .chart-subtitle
          font-size: 14px
        .chart-notes,
        .chart-source
          text-align: center
          font-size: 13px
